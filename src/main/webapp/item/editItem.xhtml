<!DOCTYPE html[
    <!ENTITY eacute "&#225;"> 
]>
<html xmlns="http://www.w3.org/1999/xhtml"
	xmlns:h="http://java.sun.com/jsf/html"
	xmlns:f="http://java.sun.com/jsf/core"
	xmlns:ui="http://java.sun.com/jsf/facelets"
	xmlns:t="http://myfaces.apache.org/tomahawk">
<body>
	<ui:composition template="/home/template/mainLayout.xhtml">
		<f:metadata>
		    <f:viewParam name="item" value="#{itemBean.itemId}"/>            
	 		<f:event listener="#{itemBean.checkItemAndUser}" type="preRenderView" />
	 	</f:metadata>
		<ui:define name="mainDiv"> 
			<h:outputStylesheet name="css/item.css" target="head" />
			<h:outputStylesheet name="js/rondell/jquery.rondell.css" target="head" />
			<h:outputScript name="js/modernizr-2.0.6.min.js" target="head" />
			<h:outputScript name="js/jquery.mousewheel-3.0.6.min.js" target="head" />
			<h:outputScript name="js/rondell/jquery.rondell.js" target="head" />
			<h:outputScript name="js/_initEditItem.js" target="head" />
			<h:outputScript target="head">
				$(function(){
					$("#editItemForm\\:title").tokenInput(
						"#{facesContext.externalContext.requestContextPath}/rest/search/item/?ot=true",
						 {
						 	theme: "facebook",
			    			hintText: "Ahahaha",
						 	minLength: 2,
						 	queryParam: "r"
						 }
					);
					$("#editItemForm #itemCategory > ul").menu({
						focus: 
							function(e, ui){
								var keyword = ui.item;
								if(!keyword.is("[data-filled='true']") &amp;&amp; keyword.is("[data-keyword-id]")){
									$.getJSON(
										"#{facesContext.externalContext.requestContextPath}/rest/search/item/children", 
										{
											i : keyword.attr("data-keyword-id"), 
											t : keyword.attr("data-keyword-type")
										},
										function(data){
											console.log(data.length);
											if(data.length > 0){
												var subKeywordList = keyword.children("ul");
												$.each(data, function(i, subKeyword){
													if(!$("[data-keyword-id='"+subKeyword.id+"'][data-keyword-type='"+subKeyword.keywordTypeId+"']",subKeywordList).is("*")){
														subKeywordList.append(
															$("<li />")
																.attr("data-keyword-id",subKeyword.id)
																.attr("data-keyword-type",subKeyword.keywordTypeId)
																.append(
																	$("<a />")
																	.attr("href", "#")
																	.text(subKeyword.name)
																)
														);
													}
												});
											}
											$("#itemMenuCategory").menu("refresh");
										}
									);
									keyword.attr("data-filled","true")
								}
							},
						select:
							function(event,ui){
								var keyword = ui.item;
								$.getJSON(
									"#{facesContext.externalContext.requestContextPath}/rest/search/item/breadcrumb", 
									{
										i : keyword.attr("data-keyword-id"), 
										t : keyword.attr("data-keyword-type")
									},
									function(data){
										var category = $("<li />")
														.attr("data-keyword-id", keyword.attr("data-keyword-id"))
														.attr("data-keyword-type", keyword.attr("data-keyword-type"));
										$.each(data, function(i, parentKeyword){
												category.append(
														$("<span />")
															.attr("data-keyword-id", parentKeyword.id)
															.text(parentKeyword.name)
												);
												if(i &lt; data.length - 1){
													category.append($("<span />").text(" &gt; "));
												}
										});
										category.append($("<span />").addClass("delete").text("x"));
										$("#selectedCategory").append(category);
									}
								);
							}
					});
				});
			</h:outputScript>
			<h:form id="editItemForm" method="post" enctype="multipart/form-data">
				<h:messages></h:messages>
				<div id="itemDescription">
					<div id="itemCategory">
						<ul id="selectedCategory"/>
						<ul id="itemMenuCategory">
							<li>
								<a href="#">Categories</a>
								<ul>
								<ui:repeat var="entry" value="#{menuBean.rootCategoriesEntries}">
									<li data-keyword-id="#{entry.id}" data-keyword-type="#{entry.keywordType.id}">
										<a href="#" >#{entry.name}</a>
										<h:panelGroup rendered="#{!empty entry.children}">
											<ul>
												<ui:repeat var="subEntry" value="#{entry.children}">
													<li data-keyword-id="#{subEntry.id}" data-keyword-type="#{subEntry.keywordType.id}">
														<a href="#" >#{subEntry.name}</a>
														<h:panelGroup rendered="#{!empty subEntry.children}">
															<ul />
														</h:panelGroup>
													</li>
												</ui:repeat>
											</ul>
										</h:panelGroup>
									</li>
								</ui:repeat>
								</ul>
							</li>
						</ul>
					</div>
					<div id="itemTitle">
						<div>
							<div class="field">
								<div class="labelTop">
									<h:outputLabel for="title">Titre</h:outputLabel>
								</div>
								<h:inputText id="title" size="58" value="#{itemBean.title}" />
							</div>
						</div>
					</div>
					<div id="clueForIdentifiecation">
						<h:inputHidden id="keywordList" value="#{itemBean.keywordListString}"/>
					</div>
					<div>
						<div class="field">
							<div class="labelTop"><h:outputLabel for="description">Description</h:outputLabel></div>
							<h:inputTextarea id="description" label="desc" cols="45" rows="18" value="#{itemBean.description}"/>
						</div>
					</div>
				</div>
				<div id="itemImages">
					<ui:repeat var="image" value="#{itemBean.fileList}">
						<div class="uploadedImage">
							<a href="#" rel="lightbox[uploadPic]">
								<h:graphicImage value="/image/#{image.id}" />
							</a>
							<div class="removePic"><h:commandLink action="#{itemBean.removePic(image.id)}" value="Supprimer" /></div>
						</div>
					</ui:repeat>
				</div>
				<div>
					<t:inputFileUpload id="choosePicButton" accept="image/png,image/jpeg" value="#{itemBean.newFile}" />
					<div id="uploadPicButton"><h:commandButton value="Ajouter l'image" id="addPicButton" action="#{itemBean.uploadPic}"/></div>
				</div>
				<ul id="wishies">
					<li>
						<label>Cat&#233;gorie : </label> <input type="text" id="wishiesCategory" value="" />
						<label>Objet : </label> <input type="text" id="wishiesField" value=""/>	<h:inputHidden id="wishiesList" value="#{itemBean.wishiesListString}"/>
					</li>
				</ul>
				<div id="saveButton">
					<h:commandButton value="Cr&#233;er" action="#{itemBean.createItem}" rendered="#{!itemBean.item.idSet}"/>
					<h:commandButton value="Modifier" action="#{itemBean.updateItem}" rendered="#{itemBean.item.idSet}"/>
				</div>
			</h:form>
	  	</ui:define>
	</ui:composition>
</body>
</html>
